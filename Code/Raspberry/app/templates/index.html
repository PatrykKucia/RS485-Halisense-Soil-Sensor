<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Gleby</title>
    <style>
        body { font-family: sans-serif; padding: 10px; background: #f4f4f4; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 20px; }
        
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 30px;
        }
        @media (max-width: 768px) { .charts-grid { grid-template-columns: 1fr; } }

        .chart-box { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
        .chart-container { position: relative; height: 250px; width: 100%; }
        .chart-box h3 { text-align: center; margin: 0 0 10px 0; font-size: 16px; color: #555; }

        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
        th { background-color: #4CAF50; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        
        /* Style przyciskÃ³w */
        .controls-row {
            display: flex; gap: 10px; margin-bottom: 20px; flex-wrap: wrap; 
            align-items: center; justify-content: space-between;
            background: #eee; padding: 10px; border-radius: 8px;
        }
        /* ZwiÄ™kszyÅ‚em odstÄ™p na dole do 40px */
        .btn-container { 
            display: flex; 
            gap: 10px; 
            margin-bottom: 40px; /* <--- TU ZMIANA (ByÅ‚o 20px) */
            flex-wrap: wrap; 
            flex: 1; 
        }
        .btn {
            text-align: center; color: white; padding: 10px 15px; 
            text-decoration: none; border-radius: 5px; font-weight: bold; font-size: 14px; 
            cursor: pointer; border: none; flex: 1; min-width: 120px;
        }
        .btn-db { background: #008CBA; }      
        .btn-csv { background: #27ae60; }     
        .btn-reset { background: #c0392b; }
        .btn-time { background: #f39c12; } 
        .btn-save { background: #8e44ad; max-width: 100px;} /* Fioletowy */
        
        .settings-box {
            display: flex; align-items: center; gap: 10px;
            background: white; padding: 5px 10px; border-radius: 5px; border: 1px solid #ddd;
        }
        select { padding: 8px; border-radius: 4px; border: 1px solid #ccc; font-size: 14px; }
        
        .btn:hover { opacity: 0.9; }          
    </style>
    <script src="/static/chart.js"></script>
</head>
<body>

<div class="container">
    <h1>ğŸŒ± Monitor Gleby</h1>
    
    <div class="controls-row">
        <div class="settings-box">
            <span>â±ï¸ Co ile mierzyÄ‡:</span>
            <select id="intervalSelect">
                <option value="1">1 sekunda</option>
                <option value="10">10 sekund</option>
                <option value="30">30 sekund</option>
                <option value="60">1 minuta</option>
                <option value="600">10 minut</option>
                <option value="3600">1 godzina</option>
            </select>
            <button onclick="setIntervalTime()" class="btn btn-save">Zapisz</button>
        </div>

        <button onclick="syncTime()" class="btn btn-time">ğŸ•’ Ustaw Czas</button>
    </div>

    <div class="btn-container">
        <a href="/download_db" class="btn btn-db">ğŸ’¾ Baza (.db)</a>
        <a href="/download_csv" class="btn btn-csv">ğŸ“Š Excel (.csv)</a>
        <a href="/reset_db" class="btn btn-reset" onclick="return confirm('Czy na pewno USUNÄ„Ä† WSZYSTKIE DANE?');">ğŸ—‘ï¸ WyczyÅ›Ä‡</a>
    </div>

    <div class="charts-grid">
        <div class="chart-box"><h3>ğŸ’§ WilgotnoÅ›Ä‡ (%)</h3><div class="chart-container"><canvas id="humChart"></canvas></div></div>
        <div class="chart-box"><h3>ğŸŒ¡ï¸ Temperatura (Â°C)</h3><div class="chart-container"><canvas id="tempChart"></canvas></div></div>
        <div class="chart-box"><h3>âš¡ EC (uS/cm)</h3><div class="chart-container"><canvas id="ecChart"></canvas></div></div>
        <div class="chart-box"><h3>ğŸ§ª pH</h3><div class="chart-container"><canvas id="phChart"></canvas></div></div>
    </div>

    <h2>ğŸ“‹ Ostatnie Pomiary</h2>
    <table id="dataTable">
        <thead><tr><th>Czas</th><th>WilgotnoÅ›Ä‡</th><th>Temp</th><th>EC</th><th>pH</th></tr></thead>
        <tbody></tbody>
    </table>
</div>

<script>
    // --- FUNKCJA ZMIANY INTERWAÅU ---
    async function setIntervalTime() {
        const val = document.getElementById('intervalSelect').value;
        try {
            const response = await fetch('/set_interval', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ interval: val })
            });
            const result = await response.json();
            alert("Zmieniono czÄ™stotliwoÅ›Ä‡ na: " + val + "s");
        } catch (e) { alert("BÅ‚Ä…d: " + e); }
    }

    // Pobierz aktualne ustawienie przy starcie
    async function loadSettings() {
        try {
            const response = await fetch('/get_settings');
            const data = await response.json();
            document.getElementById('intervalSelect').value = data.interval;
        } catch(e) { console.log(e); }
    }

    // --- FUNKCJA SYNCHRONIZACJI CZASU ---
    async function syncTime() {
        const now = new Date();
        const year = now.getFullYear();
        const month = String(now.getMonth() + 1).padStart(2, '0');
        const day = String(now.getDate()).padStart(2, '0');
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const seconds = String(now.getSeconds()).padStart(2, '0');
        const timeStr = `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
        
        if(confirm(`Czy ustawiÄ‡ czas urzÄ…dzenia na:\n${timeStr}?`)) {
            try {
                const response = await fetch('/set_time', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ time: timeStr })
                });
                const result = await response.json();
                alert("Sukces! " + result.message);
                setTimeout(() => location.reload(), 1000); 
            } catch (error) { alert("BÅ‚Ä…d: " + error); }
        }
    }

    // --- WYKRESY ---
    let chartInstances = { hum: null, temp: null, ec: null, ph: null };

    async function fetchData() {
        try {
            const response = await fetch('/api/data');
            const data = await response.json();
            updateCharts(data);
            updateTable(data);
        } catch (error) { console.error(error); }
    }

    function updateTable(data) {
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = '';
        [...data].reverse().forEach(row => {
            const timeOnly = row.timestamp.split(' ')[1]; 
            const tr = `<tr><td>${timeOnly}</td><td>${row.hum}%</td><td>${row.temp}Â°C</td><td>${row.ec}</td><td>${row.ph}</td></tr>`;
            tbody.innerHTML += tr;
        });
    }

    function createChart(ctxId, label, data, labels, color, chartKey) {
        const ctx = document.getElementById(ctxId).getContext('2d');
        if (chartInstances[chartKey]) chartInstances[chartKey].destroy();
        chartInstances[chartKey] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{ label: label, data: data, borderColor: color, backgroundColor: color + '33', borderWidth: 2, pointRadius: 2, fill: true, tension: 0 }]
            },
            options: {
                responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false },
                scales: { x: { display: true, ticks: { maxTicksLimit: 6 } }, y: { beginAtZero: false } },
                plugins: { legend: { display: false } } 
            }
        });
    }

    function updateCharts(data) {
        const labels = data.map(row => row.timestamp.split(' ')[1]); 
        createChart('humChart', 'WilgotnoÅ›Ä‡ %', data.map(r => r.hum), labels, '#3498db', 'hum'); 
        createChart('tempChart', 'Temp Â°C', data.map(r => r.temp), labels, '#e74c3c', 'temp');   
        createChart('ecChart', 'EC uS/cm', data.map(r => r.ec), labels, '#f1c40f', 'ec');        
        createChart('phChart', 'pH', data.map(r => r.ph), labels, '#2ecc71', 'ph');              
    }

    loadSettings(); // Wczytaj interwaÅ‚ przy starcie
    fetchData();
    setInterval(fetchData, 5000);
</script>

</body>
</html>