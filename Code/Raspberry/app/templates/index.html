<!DOCTYPE html>
<html lang="pl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Monitor Gleby</title>
    <style>
        body { font-family: sans-serif; padding: 10px; background: #f4f4f4; }
        .container { max-width: 900px; margin: 0 auto; background: white; padding: 15px; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 20px; }
        
        /* Styl dla siatki wykresÃ³w */
        .charts-grid {
            display: grid;
            grid-template-columns: 1fr 1fr; /* Dwie kolumny na komputerze */
            gap: 20px;
            margin-bottom: 30px;
        }

        /* Na telefonach (ekrany wÄ™Å¼sze niÅ¼ 768px) zrÃ³b jednÄ… kolumnÄ™ */
        @media (max-width: 768px) {
            .charts-grid {
                grid-template-columns: 1fr; 
            }
        }

        .chart-box {
            background: #fff;
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        
        .chart-box h3 { text-align: center; margin: 0 0 10px 0; font-size: 16px; color: #555; }

        /* Styl tabeli */
        table { width: 100%; border-collapse: collapse; margin-top: 20px; font-size: 14px; }
        th, td { border: 1px solid #ddd; padding: 6px; text-align: center; }
        th { background-color: #4CAF50; color: white; }
        tr:nth-child(even) { background-color: #f2f2f2; }
        
        /* Przycisk pobierania */
        .btn-download {
            display: block; width: 100%; text-align: center; background: #008CBA; color: white; 
            padding: 10px 0; text-decoration: none; border-radius: 5px; margin-bottom: 20px;
        }
    </style>
    <script src="static/chart.js"></script>
</head>
<body>

<div class="container">
    <h1>ğŸŒ± Monitor Gleby</h1>
    
    <style>
        /* Style przyciskÃ³w */
        .btn-container {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap; /* Å»eby na maÅ‚ym ekranie siÄ™ Å‚adnie ukÅ‚adaÅ‚y */
        }
        .btn {
            flex: 1;
            text-align: center; 
            color: white; 
            padding: 12px 0; /* TrochÄ™ wiÄ™ksze przyciski */
            text-decoration: none; 
            border-radius: 5px;
            font-weight: bold;
            font-size: 14px;
            min-width: 150px; /* Minimalna szerokoÅ›Ä‡ */
        }
        .btn-db { background: #008CBA; }      /* Niebieski - Baza */
        .btn-csv { background: #27ae60; }     /* Zielony - CSV */
        .btn-reset { background: #c0392b; }   /* Czerwony - RESET */
        
        .btn:hover { opacity: 0.9; }          /* Efekt najechania myszkÄ… */
    </style>

    <div class="btn-container">
        <a href="/download_db" class="btn btn-db">ğŸ’¾ Baza (.db)</a>
        <a href="/download_csv" class="btn btn-csv">ğŸ“Š Excel (.csv)</a>
        
        <a href="/reset_db" class="btn btn-reset" onclick="return confirm('UWAGA! \nCzy na pewno chcesz USUNÄ„Ä† WSZYSTKIE POMIARY?\n\nTego procesu nie da siÄ™ cofnÄ…Ä‡!');">
            ğŸ—‘ï¸ WyczyÅ›Ä‡ dane
        </a>
    </div>

    <div class="charts-grid">
        <div class="chart-box">
            <h3>ğŸ’§ WilgotnoÅ›Ä‡ (%)</h3>
            <canvas id="humChart"></canvas>
        </div>
        <div class="chart-box">
            <h3>ğŸŒ¡ï¸ Temperatura (Â°C)</h3>
            <canvas id="tempChart"></canvas>
        </div>
        <div class="chart-box">
            <h3>âš¡ EC (uS/cm)</h3>
            <canvas id="ecChart"></canvas>
        </div>
        <div class="chart-box">
            <h3>ğŸ§ª pH</h3>
            <canvas id="phChart"></canvas>
        </div>
    </div>

    <h2>ğŸ“‹ Ostatnie Pomiary</h2>
    <table id="dataTable">
        <thead>
            <tr>
                <th>Czas</th>
                <th>WilgotnoÅ›Ä‡</th>
                <th>Temp</th>
                <th>EC</th>
                <th>pH</th>
            </tr>
        </thead>
        <tbody>
            </tbody>
    </table>
</div>

<script>
    // Zmienne globalne na instancje wykresÃ³w
    let chartInstances = {
        hum: null,
        temp: null,
        ec: null,
        ph: null
    };

    async function fetchData() {
        try {
            const response = await fetch('/api/data');
            const data = await response.json();
            updateCharts(data);
            updateTable(data);
        } catch (error) {
            console.error("BÅ‚Ä…d pobierania danych:", error);
        }
    }

    function updateTable(data) {
        const tbody = document.querySelector('#dataTable tbody');
        tbody.innerHTML = '';
        [...data].reverse().forEach(row => {
            // Skracamy czas do samej godziny dla czytelnoÅ›ci w tabeli (opcjonalne)
            const timeOnly = row.timestamp.split(' ')[1]; 
            const tr = `<tr>
                <td>${timeOnly}</td>
                <td>${row.hum}%</td>
                <td>${row.temp}Â°C</td>
                <td>${row.ec}</td>
                <td>${row.ph}</td>
            </tr>`;
            tbody.innerHTML += tr;
        });
    }

    function createChart(ctxId, label, data, labels, color, chartKey) {
        const ctx = document.getElementById(ctxId).getContext('2d');
        
        // JeÅ›li wykres juÅ¼ istnieje, zniszcz go przed narysowaniem nowego
        if (chartInstances[chartKey]) {
            chartInstances[chartKey].destroy();
        }

        chartInstances[chartKey] = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: label,
                    data: data,
                    borderColor: color,
                    backgroundColor: color + '33', // Przezroczyste tÅ‚o (hex code + opacity)
                    borderWidth: 2,
                    pointRadius: 2,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // WaÅ¼ne dla CSS Grid
                interaction: { mode: 'index', intersect: false },
                scales: {
                    x: { display: true, ticks: { maxTicksLimit: 5 } }, // Ogranicz liczbÄ™ etykiet na osi X
                    y: { beginAtZero: false }
                },
                plugins: { legend: { display: false } } // Ukrywamy legendÄ™ bo jest nagÅ‚Ã³wek
            }
        });
    }

    function updateCharts(data) {
        // Przygotowanie danych
        const labels = data.map(row => row.timestamp.split(' ')[1]); // Tylko godzina
        const humData = data.map(row => row.hum);
        const tempData = data.map(row => row.temp);
        const ecData = data.map(row => row.ec);
        const phData = data.map(row => row.ph);

        // Rysowanie 4 wykresÃ³w
        createChart('humChart', 'WilgotnoÅ›Ä‡ %', humData, labels, '#3498db', 'hum'); // Niebieski
        createChart('tempChart', 'Temp Â°C', tempData, labels, '#e74c3c', 'temp');   // Czerwony
        createChart('ecChart', 'EC uS/cm', ecData, labels, '#f1c40f', 'ec');        // Å»Ã³Å‚ty/PomaraÅ„czowy
        createChart('phChart', 'pH', phData, labels, '#2ecc71', 'ph');              // Zielony
    }

    // OdÅ›wieÅ¼anie co 5 sekund
    fetchData();
    setInterval(fetchData, 5000);
</script>

</body>
</html>
